"use strict";(self.webpackChunkswarmcloud_docs=self.webpackChunkswarmcloud_docs||[]).push([[5006],{2498:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>u,contentTitle:()=>i,default:()=>y,frontMatter:()=>o,metadata:()=>p,toc:()=>g});r(6540);var n=r(5680);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function s(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}const o={title:"Server as Peer",sidebar_position:6},i=void 0,p={unversionedId:"super-peer",id:"super-peer",title:"Server as Peer",description:"Introduction",source:"@site/docs/guides/super-peer.mdx",sourceDirName:".",slug:"/super-peer",permalink:"/home/guides/super-peer",draft:!1,tags:[],version:"current",sidebarPosition:6,frontMatter:{title:"Server as Peer",sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"P2P Optimization",permalink:"/home/guides/optimization"},next:{title:"eCDN Usage",permalink:"/home/guides/ecdn"}},u={},g=[{value:"Introduction",id:"introduction",level:2},{value:"Server Spec",id:"server-spec",level:2},{value:"Linux OS Requirement",id:"linux-os-requirement",level:2},{value:"Install",id:"install",level:2},{value:"Install Automatically",id:"install-automatically",level:3},{value:"Install Manually",id:"install-manually",level:3},{value:"Install Node.js",id:"install-nodejs",level:4},{value:"Download super-peer.zip",id:"download-super-peerzip",level:4},{value:"Start Super Peer",id:"start-super-peer",level:4},{value:"Register Super Peer in Dashboard",id:"register-super-peer-in-dashboard",level:2},{value:"Signal Configuration",id:"signal-configuration",level:2},{value:"Seeding Strategy",id:"seeding-strategy",level:2},{value:"Monitor",id:"monitor",level:2},{value:"Access Token (Optional)",id:"access-token-optional",level:2},{value:"Signaling Address (Optional)",id:"signaling-address-optional",level:2},{value:"Auto Startup (Optional)",id:"auto-startup-optional",level:2},{value:"Update Super Peer (Optional)",id:"update-super-peer-optional",level:2},{value:"Restful API",id:"restful-api",level:2},{value:"HTTP Header",id:"http-header",level:3},{value:"Ping",id:"ping",level:3},{value:"POST Body",id:"post-body",level:4},{value:"Response",id:"response",level:4},{value:"Seed",id:"seed",level:3},{value:"POST Body",id:"post-body-1",level:4},{value:"Body Example\uff1a",id:"body-example",level:4},{value:"Response",id:"response-1",level:4},{value:"Stats",id:"stats",level:3},{value:"Request all real-time statistics",id:"request-all-real-time-statistics",level:4},{value:"Request statistics for one worker",id:"request-statistics-for-one-worker",level:4},{value:"Request statistics for one channelId",id:"request-statistics-for-one-channelid",level:4},{value:"Stop all workers",id:"stop-all-workers",level:3},{value:"Stop one worker",id:"stop-one-worker",level:3},{value:"Restart all workers",id:"restart-all-workers",level:3},{value:"Restart one worker",id:"restart-one-worker",level:3}],c={toc:g},d="wrapper";function y(e){var{components:t}=e,r=s(e,["components"]);return(0,n.yg)(d,l(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){a(e,t,r[t])})}return e}({},c,r),{components:t,mdxType:"MDXLayout"}),(0,n.yg)("h2",{id:"introduction"},"Introduction"),(0,n.yg)("p",null,'This program makes server as a peer (Super Peer) to serve clients that cannot connect to other peers. The master/worker architecture is adopted. The master is responsible for creating and scheduling worker processes, and the worker process is responsible for executing "seeding". Each worker can only seed for one channel, and a channel can be seeded by multiple workers simultaneously.'),(0,n.yg)("h2",{id:"server-spec"},"Server Spec"),(0,n.yg)("p",null,"Each worker process can serve up to 200 viewers, requires approximately one CPU core, 400MB of memory, and 200Mbps of bandwidth, it also requires sufficient disk space to cache content for VOD."),(0,n.yg)("h2",{id:"linux-os-requirement"},"Linux OS Requirement"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},"Ubuntu 20 or newer"),(0,n.yg)("li",{parentName:"ul"},"CentOS 8 or newer")),(0,n.yg)("h2",{id:"install"},"Install"),(0,n.yg)("h3",{id:"install-automatically"},"Install Automatically"),(0,n.yg)("p",null,"The script to start super peer with listening port 8080 is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"wget -qN https://cdn.swarmcloud.net/super-peer.sh && bash super-peer.sh --port 8080\n")),(0,n.yg)("h3",{id:"install-manually"},"Install Manually"),(0,n.yg)("h4",{id:"install-nodejs"},"Install Node.js"),(0,n.yg)("p",null,"Ignore this step if you have installed node.js."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"wget https://npmmirror.com/mirrors/node/v18.15.0/node-v18.15.0-linux-x64.tar.xz\ntar -xvf node-v18.15.0-linux-x64.tar.xz\nsudo mkdir -p /usr/local/nodejs\nsudo mv node-v18.15.0-linux-x64/* /usr/local/nodejs/\nsudo ln -s /usr/local/nodejs/bin/node /usr/local/bin\nsudo ln -s /usr/local/nodejs/bin/npm /usr/local/bin\n")),(0,n.yg)("h4",{id:"download-super-peerzip"},"Download super-peer.zip"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"wget https://cdn.swarmcloud.net/super-peer.zip\nunzip super-peer.zip\n")),(0,n.yg)("h4",{id:"start-super-peer"},"Start Super Peer"),(0,n.yg)("p",null,"The script to start super peer with listening port 8080 is as follows:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"cd super-peer && echo listenPort=8080 >> .env\n")),(0,n.yg)("p",null,"pm2 is a Node.js application process manager that is used for keeping super peer alive forever."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"npm i -g pm2\nsudo ln -s /usr/local/nodejs/bin/pm2 /usr/local/bin\npm2 start index.js -n super-peer\n")),(0,n.yg)("h2",{id:"register-super-peer-in-dashboard"},"Register Super Peer in Dashboard"),(0,n.yg)("p",null,'Log in dashboard, click on "P2P Setting" -> "Server as Peer" -> "+Super Peer", input the server URL(http://ip:port) and bandwidth, then click "Confirm". If the server status shows "Stopped", it means that the server cannot be connected. Please ensure that the firewall configuration is correct.'),(0,n.yg)("admonition",{type:"note"},(0,n.yg)("p",{parentName:"admonition"},"For live streaming, super peer can only serve clients within a straight distance of 7000 kilometers. Please choose a server that is as close to the user as possible to deploy.")),(0,n.yg)("h2",{id:"signal-configuration"},"Signal Configuration"),(0,n.yg)("p",null,"If your application has configured signal address on the console, you need to configure the same signal address for the super peer domain."),(0,n.yg)("h2",{id:"seeding-strategy"},"Seeding Strategy"),(0,n.yg)("p",null,"By default, the tracker server will automatically seed based on the current hot channel rankings. You can turn off automatic seeding and do it manually."),(0,n.yg)("h2",{id:"monitor"},"Monitor"),(0,n.yg)("p",null,"Click on the monitor button of the corresponding server on the page to view information such as the number of current connected peers, uploaded traffic in KB, and system resource usage for each worker process. You can also restart or kill a specific worker process."),(0,n.yg)("h2",{id:"access-token-optional"},"Access Token (Optional)"),(0,n.yg)("p",null,"You can set an access token before starting the program:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"echo 'accessToken=ACCESS_TOKEN' >> .env\n")),(0,n.yg)("p",null,"ACCESS_TOKEN is the self-defined string, which should be same as the one registered in dashboard."),(0,n.yg)("h2",{id:"signaling-address-optional"},"Signaling Address (Optional)"),(0,n.yg)("p",null,"In addition to configuring the signaling address on the console, it can also be configured through the .env file to use different signaling addresses in different regions:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"echo 'signal1=wss://example.com' >> .env\n# echo 'signal2=wss://example2.com' >> .env\n")),(0,n.yg)("p",null,"signal1 is the primary signaling address, and signal2 is the backup signaling address."),(0,n.yg)("h2",{id:"auto-startup-optional"},"Auto Startup (Optional)"),(0,n.yg)("p",null,"Start the program then run:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"pm2 save && pm2 startup\n")),(0,n.yg)("h2",{id:"update-super-peer-optional"},"Update Super Peer (Optional)"),(0,n.yg)("p",null,"Replace the file with new version, then restart the process:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"wget -N https://cdn.swarmcloud.net/super-peer.zip && unzip -o super-peer.zip\npm2 restart super-peer\npm2 save\n")),(0,n.yg)("p",null,"or simply run:"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"wget -qN https://cdn.swarmcloud.net/super-peer.sh && bash super-peer.sh\n")),(0,n.yg)("h2",{id:"restful-api"},"Restful API"),(0,n.yg)("h3",{id:"http-header"},"HTTP Header"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"center"},"Name"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Type"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Required"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"center"},"X-ACCESS-TOKEN"),(0,n.yg)("td",{parentName:"tr",align:"center"},"string"),(0,n.yg)("td",{parentName:"tr",align:"center"},"\u8bbf\u95eetoken, \u9700\u8981\u4e0e\u8d85\u7ea7\u8282\u70b9\u542f\u52a8\u65f6\u8bbe\u7f6e\u7684\u4e00\u81f4"),(0,n.yg)("td",{parentName:"tr",align:"center"},"\u5426")))),(0,n.yg)("h3",{id:"ping"},"Ping"),(0,n.yg)("p",null,"Check connectivity while setting bandwidth or worker count"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /ping\n")),(0,n.yg)("h4",{id:"post-body"},"POST Body"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"center"},"Name"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Type"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Required"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"center"},"bandwidth"),(0,n.yg)("td",{parentName:"tr",align:"center"},"int"),(0,n.yg)("td",{parentName:"tr",align:"center"},"bandwidth in Mbps"),(0,n.yg)("td",{parentName:"tr",align:"center"},"No")),(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"center"},"workers"),(0,n.yg)("td",{parentName:"tr",align:"center"},"int"),(0,n.yg)("td",{parentName:"tr",align:"center"},"Force the number of worker processes"),(0,n.yg)("td",{parentName:"tr",align:"center"},"No")))),(0,n.yg)("h4",{id:"response"},"Response"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"center"},"Name"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Type"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"center"}))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"center"},"workers"),(0,n.yg)("td",{parentName:"tr",align:"center"},"int"),(0,n.yg)("td",{parentName:"tr",align:"center"},"Current number of workers processes"),(0,n.yg)("td",{parentName:"tr",align:"center"})))),(0,n.yg)("h3",{id:"seed"},"Seed"),(0,n.yg)("p",null,"Send seeding request"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /seed\n")),(0,n.yg)("h4",{id:"post-body-1"},"POST Body"),(0,n.yg)("table",null,(0,n.yg)("thead",{parentName:"table"},(0,n.yg)("tr",{parentName:"thead"},(0,n.yg)("th",{parentName:"tr",align:"center"},"Name"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Type"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Description"),(0,n.yg)("th",{parentName:"tr",align:"center"},"Required"))),(0,n.yg)("tbody",{parentName:"table"},(0,n.yg)("tr",{parentName:"tbody"},(0,n.yg)("td",{parentName:"tr",align:"center"},"list"),(0,n.yg)("td",{parentName:"tr",align:"center"},"array"),(0,n.yg)("td",{parentName:"tr",align:"center"},"The list of seeding information"),(0,n.yg)("td",{parentName:"tr",align:"center"},"Yes")))),(0,n.yg)("h4",{id:"body-example"},"Body Example\uff1a"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-json"},'{\n    "list": [\n        {\n            "token": user token\n            "channel": channel ID(Base64 encoded)\n            "trackerZone": cn, hk, us\n            "live": live streaming or vod\n            "signal1": primary signal address\n            "signal2": backup signal address\n            "priority": priority of seeding\n            "keepAlive": always alive\n            "noUseDiskCache": does not use disk cache for vod\n            "maxConnections": maximum p2p connections, default is 80\n            "label": customized super peer label\n        }\n    ]\n\n}\n')),(0,n.yg)("h4",{id:"response-1"},"Response"),(0,n.yg)("p",null,"Status: 200"),(0,n.yg)("h3",{id:"stats"},"Stats"),(0,n.yg)("h4",{id:"request-all-real-time-statistics"},"Request all real-time statistics"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"GET /stats\n")),(0,n.yg)("h4",{id:"request-statistics-for-one-worker"},"Request statistics for one worker"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"GET /stats/:pid\n")),(0,n.yg)("p",null,"Where pid is the process id of the worker"),(0,n.yg)("h4",{id:"request-statistics-for-one-channelid"},"Request statistics for one channelId"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"GET /stats/:channelId\n")),(0,n.yg)("p",null,"Where channelId is the base64 encoded channel id"),(0,n.yg)("h3",{id:"stop-all-workers"},"Stop all workers"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /stop_all\n")),(0,n.yg)("h3",{id:"stop-one-worker"},"Stop one worker"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /stop/:pid\n")),(0,n.yg)("h3",{id:"restart-all-workers"},"Restart all workers"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /restart_all\n")),(0,n.yg)("h3",{id:"restart-one-worker"},"Restart one worker"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-sh"},"POST /restart/:pid\n")))}y.isMDXComponent=!0},5680:(e,t,r)=>{r.d(t,{xA:()=>u,yg:()=>y});var n=r(6540);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){a(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var i=n.createContext({}),p=function(e){var t=n.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},g="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef(function(e,t){var r=e.components,a=e.mdxType,l=e.originalType,i=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),g=p(r),d=a,y=g["".concat(i,".").concat(d)]||g[d]||c[d]||l;return r?n.createElement(y,s(s({ref:t},u),{},{components:r})):n.createElement(y,s({ref:t},u))});function y(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=r.length,s=new Array(l);s[0]=d;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o[g]="string"==typeof e?e:a,s[1]=o;for(var p=2;p<l;p++)s[p]=r[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}d.displayName="MDXCreateElement"}}]);